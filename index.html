<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jornada de Qualificação Imersiva</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <style>
        :root {
            --roxo-fundo: #10101A;
            --roxo-painel: #181828;
            --roxo-primario: #8A2BE2;
            --verde-neon: #00DF9A;
            --branco-texto: #F0F0F0;
            --cinza-texto: #a0a0b0;
            --vermelho-erro: #e74c3c;
            --font-family: 'Lexend', sans-serif;
            --vh: 1vh; /* Variável de fallback */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: var(--font-family);
            background: var(--roxo-fundo);
            color: var(--branco-texto);
        }

        body { display: flex; justify-content: center; align-items: center; }

        .interaction-container {
            width: 95vw;
            height: calc(var(--vh, 1vh) * 90);
            max-width: 420px;
            max-height: 850px;
            background: var(--roxo-painel);
            border-radius: 24px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            opacity: 0;
            transition: opacity 1s ease-out;
        }

        .interaction-container.visible { opacity: 1; }
        .media-container { position: relative; flex: 1; background-color: #000; }
        .background-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.8s ease-in-out; }
        .background-image.active { opacity: 1; }
        #final-video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .media-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(24, 24, 40, 0.95) 0%, rgba(24, 24, 40, 0.6) 35%, transparent 65%); pointer-events: none; }
        .control-button { position: absolute; top: 20px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px); border-radius: 50%; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; color: var(--branco-texto); font-size: 1.2rem; cursor: pointer; z-index: 60; transition: all 0.3s ease; }
        .control-button.top-left { left: 20px; }
        .control-button.top-right { right: 20px; }
        .control-button:hover { background: var(--roxo-primario); transform: scale(1.1); }
        .control-button.muted i::after { content: '/'; position: absolute; transform: rotate(15deg) translateX(1px); font-weight: 600; }
        .message-container { position: absolute; bottom: 120px; left: 25px; right: 25px; z-index: 20; text-align: center; pointer-events: none; }
        .bot-message { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); padding: 15px 25px; border-radius: 12px; display: inline-block; line-height: 1.5; font-size: 1.1rem; font-weight: 500; opacity: 0; transform: translateY(20px); animation: fadeInMessage 0.6s ease forwards; }
        @keyframes fadeInMessage { to { opacity: 1; transform: translateY(0); } }
        .input-area { position: absolute; bottom: 0; left: 0; width: 100%; padding: 25px; z-index: 30; }
        #user-input { width: 100%; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--branco-texto); padding: 18px; border-radius: 12px; text-align: center; font-size: 1.1rem; outline: none; transition: all 0.3s ease; }
        #user-input:focus { border-color: var(--verde-neon); background: rgba(0, 223, 154, 0.1); }
        #user-input.error { border-color: var(--vermelho-erro); animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .options-container { position: absolute; bottom: 0; left: 0; width: 100%; padding: 25px; display: flex; flex-direction: column; gap: 15px; z-index: 20; }
        .option-btn { width: 100%; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--branco-texto); padding: 18px; border-radius: 12px; font-family: var(--font-family); font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); text-align: center; opacity: 0; transform: translateY(20px); animation: fadeInButton 0.5s ease forwards; }
        @keyframes fadeInButton { to { opacity: 1; transform: translateY(0); } }
        .option-btn:hover { background: var(--verde-neon); color: var(--roxo-fundo); border-color: var(--verde-neon); transform: scale(1.03); }
        #unmute-video-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; padding: 15px 30px; font-size: 1rem; font-weight: 600; color: var(--roxo-fundo); background-color: var(--verde-neon); border: none; border-radius: 30px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(0, 223, 154, 0.4); }
        #unmute-video-btn:hover { transform: translate(-50%, -50%) scale(1.05); box-shadow: 0 8px 30px rgba(0, 223, 154, 0.6); }
        @media (max-width: 500px) { .interaction-container { border-radius: 0; width: 100%; height: 100%; max-width: none; max-height: none; height: calc(var(--vh, 1vh) * 100); } .control-button { top: 15px; } .control-button.top-left { left: 15px; } .control-button.top-right { right: 15px; } }
    </style>
</head>
<body>

    <div id="interaction-container" class="interaction-container">
        
        <button id="back-btn" class="control-button top-left" style="display: none;" aria-label="Voltar">
            <i class="fas fa-arrow-left"></i>
        </button>

        <button id="audio-btn" class="control-button top-right" style="display: none;" aria-label="Ativar/Desativar som">
            <i class="fas fa-volume-high"></i>
        </button>

        <div class="media-container">
            <img id="image-bg-1" class="background-image" src="" alt="Contexto visual da etapa">
            <img id="image-bg-2" class="background-image" src="" alt="Contexto visual da etapa">
            <video id="final-video" src="" muted playsinline loop style="display: none;" aria-label="Vídeo final"></video>
            <div class="media-overlay"></div>
            <button id="unmute-video-btn" style="display: none;">Ativar Som</button>
        </div>

        <div id="message-container" class="message-container"></div>
        
        <form id="text-input-form" class="input-area" style="display: none;">
            <input type="text" id="user-input" autocomplete="off" aria-label="Sua resposta">
        </form>

        <div id="options-container" class="options-container"></div>
    </div>

    <audio id="background-music" loop></audio> 
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const setVhVariable = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            window.addEventListener('resize', setVhVariable);
            setVhVariable();

            // ===================================================================
            // =================== SUA ÁREA DE CONFIGURAÇÃO =====================
            // ===================================================================
            const webhookURL = 'http://localhost:5678/webhook-test/capturadeclientes';
            const finalVideoPath = 'video.mp4';
            const backgroundMusicPath = 'musica.mp3';

            const validationRegex = {
                name: /^[a-zA-ZáàãâéèêíìóòõôúùçÇÁÀÃÂÉÈÊÍÌÓÒÕÔÚÙ\s'-]{3,}$/,
                phone: /^\(?(?:[1-9][0-9])\)?\s?9?\d{4,5}-?\d{4}$/,
                email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/
            };
            const journey = [ { type: 'multiple-choice', name: "etapa_1_engajamento", image: "imagem01.jpg", options: [ { text: "Perco clientes por demora", value: 2 }, { text: "Meu processo é manual", value: 1 }, { text: "Estou apenas curioso", value: 0 } ] }, { type: 'text-input', name: 'nome', image: 'imagem02.jpg', question: 'Entendido. Para continuarmos, qual seu nome?', validation: validationRegex.name }, { type: 'text-input', name: 'email', image: 'imagem03.jpg', question: 'Obrigado. Agora, seu melhor e-mail.', validation: validationRegex.email }, { type: 'text-input', name: 'telefone', image: 'imagem04.jpg', question: 'Perfeito. E para finalizar, seu telefone.', validation: validationRegex.phone }, { type: 'multiple-choice', name: "etapa_2_solucao", image: "imagem05.jpg", options: [ { text: "Preciso automatizar agora", value: 2 }, { text: "Quero mais eficiência", value: 1 }, { text: "Tenho medo de robôs", value: 0 } ] }, { type: 'multiple-choice', name: "etapa_3_disponibilidade", image: "imagem06.jpg", options: [ { text: "Quero atender 24/7", value: 2 }, { text: "Atendo em horário comercial", value: 1 }, { text: "Meu público é específico", value: 0 } ] }, { type: 'multiple-choice', name: "etapa_4_investimento", image: "imagem07.jpg", options: [ { text: "Investir para escalar", value: 2 }, { text: "Busco custo-benefício", value: 1 }, { text: "Quero algo gratuito", value: 0 } ] }, { type: 'multiple-choice', name: "etapa_5_implementacao", image: "imagem08.jpg", options: [ { text: "Quero começar hoje", value: 2 }, { text: "Preciso de ajuda para iniciar", value: 1 }, { text: "Parece complicado", value: 0 } ] }, { type: 'multiple-choice', name: "etapa_6_concorrencia", image: "imagem09.jpg", options: [ { text: "Quero estar à frente", value: 2 }, { text: "Acompanho o mercado", value: 1 }, { text: "Não me comparo", value: 0 } ] }, { type: 'multiple-choice', name: "etapa_7_decisao", image: "imagem10.jpg", options: [ { text: "Vamos iniciar a parceria", value: 2 }, { text: "Preciso de mais detalhes", value: 1 }, { text: "Vou pensar a respeito", value: 0 } ] } ];
            
            // ======================= FIM DA CONFIGURAÇÃO =======================

            const ui = {
                interactionContainer: document.getElementById('interaction-container'),
                messageContainer: document.getElementById('message-container'),
                optionsContainer: document.getElementById('options-container'),
                inputArea: document.getElementById('text-input-form'),
                userInput: document.getElementById('user-input'),
                imageBg1: document.getElementById('image-bg-1'),
                imageBg2: document.getElementById('image-bg-2'),
                backgroundMusic: document.getElementById('background-music'),
                backBtn: document.getElementById('back-btn'),
                audioBtn: document.getElementById('audio-btn'),
                finalVideo: document.getElementById('final-video'),
                unmuteVideoBtn: document.getElementById('unmute-video-btn'),
            };

            let appState = 'JOURNEY';
            let currentStepIndex = 0;
            let userAnswers = {};
            let isProcessing = false;
            let activeImage = ui.imageBg1;
            let inactiveImage = ui.imageBg2;

            const updateImage = (newSrc) => {
                return new Promise((resolve) => {
                    if (!newSrc || activeImage.src.endsWith(newSrc.replace(/^\.\//, ''))) return resolve();
                    inactiveImage.src = newSrc;
                    const listener = () => {
                        activeImage.classList.remove('active');
                        inactiveImage.classList.add('active');
                        [activeImage, inactiveImage] = [inactiveImage, activeImage];
                        inactiveImage.removeEventListener('load', listener);
                        resolve();
                    };
                    inactiveImage.addEventListener('load', listener);
                    inactiveImage.onerror = () => {
                        console.error(`Erro ao carregar imagem: ${newSrc}`);
                        inactiveImage.removeEventListener('load', listener);
                        resolve();
                    };
                });
            };
            
            const renderStep = async () => {
                if (currentStepIndex >= journey.length) {
                    finishJourney();
                    return;
                }
                isProcessing = true;
                appState = 'JOURNEY';
                const currentStep = journey[currentStepIndex];
                ui.backBtn.style.display = currentStepIndex > 0 ? 'flex' : 'none';
                ui.audioBtn.style.display = 'flex';
                ui.finalVideo.style.display = 'none';
                await updateImage(currentStep.image);
                ui.messageContainer.innerHTML = '';
                ui.optionsContainer.innerHTML = '';
                ui.inputArea.style.display = 'none';
                if (currentStep.type === 'text-input') {
                    ui.inputArea.style.display = 'block';
                    ui.userInput.value = userAnswers[currentStep.name] || '';
                    ui.userInput.classList.remove('error');
                    ui.userInput.focus();
                    const msgEl = document.createElement('div');
                    msgEl.className = 'bot-message';
                    msgEl.textContent = currentStep.question;
                    ui.messageContainer.appendChild(msgEl);
                } else if (currentStep.type === 'multiple-choice') {
                    currentStep.options.forEach((option, index) => {
                        const button = document.createElement('button');
                        button.className = 'option-btn';
                        button.textContent = option.text;
                        button.style.animationDelay = `${index * 100}ms`;
                        button.onclick = () => handleChoice(option, currentStep.name);
                        ui.optionsContainer.appendChild(button);
                    });
                }
                setTimeout(() => isProcessing = false, 200);
            };

            const handleTextInput = () => {
                if (isProcessing) return;
                const currentStep = journey[currentStepIndex];
                const answer = ui.userInput.value.trim();
                if (currentStep.validation && !currentStep.validation.test(answer)) {
                    ui.userInput.classList.add('error');
                    setTimeout(() => ui.userInput.classList.remove('error'), 500);
                    return;
                }
                isProcessing = true;
                userAnswers[currentStep.name] = answer;
                currentStepIndex++;
                renderStep();
            };
            
            const handleChoice = (option, stepName) => {
                if (isProcessing) return;
                isProcessing = true;
                userAnswers[stepName] = { text: option.text, value: option.value };
                currentStepIndex++;
                renderStep();
            };

            const goBack = () => {
                if (isProcessing) return;
                if (currentStepIndex === 0 && appState !== 'FINISHED') return;
                isProcessing = true;
                if (appState === 'FINISHED') {
                    ui.finalVideo.pause();
                    if (!ui.backgroundMusic.muted) {
                        ui.backgroundMusic.play().catch(()=>{});
                    }
                    const lastStepName = journey[journey.length - 1].name;
                    delete userAnswers[lastStepName];
                    currentStepIndex = journey.length - 1;
                } else {
                    currentStepIndex--;
                }
                const previousStep = journey[currentStepIndex];
                delete userAnswers[previousStep.name];
                renderStep();
            };

            const classifyLead = () => {
                const score = Object.values(userAnswers).filter(answer => typeof answer === 'object' && typeof answer.value === 'number').reduce((sum, answer) => sum + answer.value, 0);
                if (score >= 10) return "Quente";
                if (score >= 5) return "Morno";
                return "Frio";
            };

            const finishJourney = async () => {
                isProcessing = true;
                appState = 'FINISHED';
                ui.inputArea.style.display = 'none';
                ui.messageContainer.innerHTML = '';
                ui.optionsContainer.innerHTML = '';
                activeImage.classList.remove('active');
                inactiveImage.classList.remove('active');
                ui.backgroundMusic.pause();
                ui.finalVideo.src = finalVideoPath;
                ui.finalVideo.style.display = 'block';
                ui.unmuteVideoBtn.style.display = 'block';
                ui.backBtn.style.display = 'flex';
                ui.finalVideo.play();
                const payload = { nome: userAnswers.nome, email: userAnswers.email, telefone: userAnswers.telefone, classificacao_final: classifyLead() };
                journey.forEach(step => { if(step.type === 'multiple-choice' && userAnswers[step.name]) { payload[step.name] = userAnswers[step.name].text; } });
                try {
                    await fetch(webhookURL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    console.log('Dados enviados com sucesso para o n8n!');
                } catch (error) {
                    console.error('Falha ao enviar dados:', error);
                } finally {
                    isProcessing = false;
                }
            };
            
            const init = async () => {
                if (backgroundMusicPath) {
                    ui.backgroundMusic.src = backgroundMusicPath;
                    ui.backgroundMusic.volume = 0.2;
                }
                const imageSources = journey.map(step => step.image).filter(Boolean);
                const imagePromises = imageSources.map(src => new Promise((resolve) => { const img = new Image(); img.src = src; img.onload = resolve; img.onerror = resolve; }));
                await Promise.all(imagePromises);
                activeImage.src = journey[0].image;
                await new Promise(resolve => setTimeout(resolve, 10));
                activeImage.classList.add('active');
                ui.interactionContainer.classList.add('visible');
                renderStep();
            };
            
            ui.inputArea.addEventListener('submit', (event) => {
                event.preventDefault();
                handleTextInput();
            });
            
            ui.backBtn.addEventListener('click', goBack);
            ui.audioBtn.addEventListener('click', () => {
                const music = ui.backgroundMusic;
                if (music.paused) { music.play().catch(() => {}); ui.audioBtn.classList.remove('muted'); } 
                else { music.pause(); ui.audioBtn.classList.add('muted'); }
            });
            ui.unmuteVideoBtn.addEventListener('click', () => {
                ui.finalVideo.muted = false;
                ui.unmuteVideoBtn.style.display = 'none';
            });
            document.body.addEventListener('click', () => {
                if (ui.backgroundMusic.paused && appState !== 'FINISHED') {
                     ui.backgroundMusic.play().catch(() => {});
                     ui.audioBtn.classList.remove('muted');
                }
            }, { once: true });
            
            init();
        });
    </script>
</body>
</html>
